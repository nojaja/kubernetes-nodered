const fs = require("fs");
const path = require("path");
const ip = require("ip");
const os = require("os");

module.exports = function (RED) {
    //IP取得
    RED.util.getLocalAddress = () => {
        const ifacesObj = {}
        ifacesObj.ipv4 = []
        ifacesObj.ipv6 = []
        const interfaces = os.networkInterfaces()
        for (let ifname in interfaces) {
            interfaces[ifname].forEach(function (iface) {
                if (!iface.internal) {
                    const broadcastAddress = ip.or(iface.address, ip.not(iface.netmask))
                    switch (iface.family) {
                        case "IPv4":
                            ifacesObj.ipv4.push({ name: ifname, address: iface.address, broadcastAddress: broadcastAddress })
                            break
                        case "IPv6":
                            ifacesObj.ipv6.push({ name: ifname, address: iface.address, broadcastAddress: broadcastAddress })
                            break
                    }
                }
            });
        }
        return ifacesObj;
    }
    //オブジェクトをパス指定で取得
    RED.util.getPropByPath = (obj, path) => {
        const pathArr = path.split('.');
        let current = obj;
        for (const prop of pathArr) {
            if (current[prop] === undefined) {
                return undefined;
            }
            current = current[prop];
        }
        return current;
    }
    //mapでのlistのpop実装
    RED.util.mappop = (map) => {
        try {
            const key = map.keys().next().value
            const result = map.get(key)
            return (map.delete(key)) ? result : null
        } catch (error) {
            return null
        }
    }
    

}